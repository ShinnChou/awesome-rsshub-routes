name: Check RSS Feeds

on:
  push:
    branches: [main]
  schedule:
    # æ¯å¤©æ—©ä¸Š 10 ç‚¹ (åŒ—äº¬æ—¶é—´ UTC+8ï¼Œå³ UTC 2 ç‚¹) è¿è¡Œ
    - cron: '0 2 * * *'
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  check-feeds:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Check RSS feeds
        id: check
        run: node scripts/check-feeds.js
        continue-on-error: true

      - name: Update or Create Issue
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            
            if (!fs.existsSync('feed-status.json')) {
              console.log('No status file found');
              return;
            }
            
            const status = JSON.parse(fs.readFileSync('feed-status.json', 'utf8'));
            const broken = status.feeds.filter(f => !f.valid);
            const issueTitle = 'ğŸ“Š RSS è®¢é˜…æºå¥åº·çŠ¶æ€æŠ¥å‘Š';
            
            // æŸ¥æ‰¾æ˜¯å¦å·²å­˜åœ¨çŠ¶æ€æŠ¥å‘Š Issue
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'feed-status'
            });
            
            const existingIssue = issues.data.find(i => i.title === issueTitle);
            
            // ç”ŸæˆæŠ¥å‘Šå†…å®¹
            let body = `## ğŸ“Š RSS è®¢é˜…æºå¥åº·çŠ¶æ€\n\n`;
            body += `> ğŸ• æœ€è¿‘æ£€æµ‹æ—¶é—´: ${status.checkTime}\n\n`;
            body += `| æŒ‡æ ‡ | æ•°å€¼ |\n|------|------|\n`;
            body += `| âœ… å¯ç”¨ | ${status.valid} |\n`;
            body += `| âŒ å¤±æ•ˆ | ${status.invalid} |\n`;
            body += `| ğŸ“ˆ æˆåŠŸç‡ | ${status.successRate} |\n\n`;
            
            if (broken.length > 0) {
              body += `### âš ï¸ å¤±æ•ˆé“¾æ¥ (${broken.length} ä¸ª)\n\n`;
              body += `| åç§° | é”™è¯¯ |\n|------|------|\n`;
              broken.forEach(f => {
                body += `| ${f.name} | ${f.error} |\n`;
              });
              body += `\n> è¯·æ£€æŸ¥è¿™äº›é“¾æ¥æ˜¯å¦éœ€è¦æ›´æ–°æˆ–ç§»é™¤\n`;
            } else {
              body += `### âœ… æ‰€æœ‰é“¾æ¥æ­£å¸¸ï¼\n\n`;
              body += `å…¨éƒ¨ ${status.total} ä¸ªè®¢é˜…æºéƒ½å¯ä»¥æ­£å¸¸è®¿é—®ã€‚\n`;
            }
            
            body += `\n---\n*æ­¤ Issue ç”± GitHub Actions è‡ªåŠ¨æ›´æ–°ï¼Œè¯·å‹¿æ‰‹åŠ¨å…³é—­*`;
            
            if (existingIssue) {
              // æ›´æ–°ç°æœ‰ Issue
              await github.rest.issues.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: existingIssue.number,
                body: body
              });
              console.log(`Updated issue #${existingIssue.number}`);
            } else {
              // åˆ›å»ºæ–° Issue
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: issueTitle,
                body: body,
                labels: ['feed-status']
              });
              console.log('Created new status issue');
            }

      - name: Update README badge data
        run: |
          if [ -f feed-status.json ]; then
            TOTAL=$(cat feed-status.json | grep -o '"total":[0-9]*' | grep -o '[0-9]*')
            VALID=$(cat feed-status.json | grep -o '"valid":[0-9]*' | grep -o '[0-9]*')
            echo "âœ… æ£€æµ‹å®Œæˆ: $VALID/$TOTAL ä¸ªé“¾æ¥å¯ç”¨"
          fi

      - name: Prepare email content
        id: email
        run: |
          if [ -f feed-status.json ]; then
            # ä½¿ç”¨ jq æˆ– node è§£æ JSON æ›´å¯é 
            TOTAL=$(node -e "console.log(require('./feed-status.json').total || 0)")
            VALID=$(node -e "console.log(require('./feed-status.json').valid || 0)")
            INVALID=$(node -e "console.log(require('./feed-status.json').invalid || 0)")
            RATE=$(node -e "console.log(require('./feed-status.json').successRate || '0%')")
            CHECK_TIME=$(node -e "console.log(require('./feed-status.json').checkTime || 'N/A')")
            
            if [ "$INVALID" -gt 0 ]; then
              echo "subject=âš ï¸ RSS è®¢é˜…æºæ£€æµ‹å‘ç° ${INVALID} ä¸ªå¤±æ•ˆé“¾æ¥" >> $GITHUB_OUTPUT
              echo "status=æœ‰é—®é¢˜" >> $GITHUB_OUTPUT
            else
              echo "subject=âœ… RSS è®¢é˜…æºæ£€æµ‹å…¨éƒ¨æ­£å¸¸" >> $GITHUB_OUTPUT
              echo "status=å…¨éƒ¨æ­£å¸¸" >> $GITHUB_OUTPUT
            fi
            
            echo "total=$TOTAL" >> $GITHUB_OUTPUT
            echo "valid=$VALID" >> $GITHUB_OUTPUT
            echo "invalid=$INVALID" >> $GITHUB_OUTPUT
            echo "rate=$RATE" >> $GITHUB_OUTPUT
            echo "check_time=$CHECK_TIME" >> $GITHUB_OUTPUT
          else
            echo "subject=â“ RSS è®¢é˜…æºæ£€æµ‹æœªç”ŸæˆæŠ¥å‘Š" >> $GITHUB_OUTPUT
            echo "status=æ£€æµ‹å¤±è´¥" >> $GITHUB_OUTPUT
            echo "total=0" >> $GITHUB_OUTPUT
            echo "valid=0" >> $GITHUB_OUTPUT
            echo "invalid=0" >> $GITHUB_OUTPUT
            echo "rate=N/A" >> $GITHUB_OUTPUT
            echo "check_time=N/A" >> $GITHUB_OUTPUT
          fi

      - name: Send email notification
        if: always()
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 587
          username: ${{ secrets.EMAIL_USERNAME }}
          password: ${{ secrets.EMAIL_PASSWORD }}
          subject: ${{ steps.email.outputs.subject }}
          to: ${{ secrets.EMAIL_TO }}
          from: RSS Feed Checker <${{ secrets.EMAIL_USERNAME }}>
          body: |
            RSS è®¢é˜…æºå¥åº·æ£€æµ‹æŠ¥å‘Š
            
            æ£€æµ‹æ—¶é—´: ${{ steps.email.outputs.check_time }}
            æ£€æµ‹çŠ¶æ€: ${{ steps.email.outputs.status }}
            
            ================================
            ğŸ“Š æ£€æµ‹ç»“æœ
            ================================
            âœ… å¯ç”¨: ${{ steps.email.outputs.valid }}
            âŒ å¤±æ•ˆ: ${{ steps.email.outputs.invalid }}
            ğŸ“ˆ æˆåŠŸç‡: ${{ steps.email.outputs.rate }}
            ğŸ“‹ æ€»æ•°: ${{ steps.email.outputs.total }}
            
            æŸ¥çœ‹è¯¦ç»†æŠ¥å‘Š:
            https://github.com/${{ github.repository }}/issues
            
            ---
            æ­¤é‚®ä»¶ç”± GitHub Actions è‡ªåŠ¨å‘é€
